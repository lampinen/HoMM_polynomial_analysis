---
title: "Polynomials tsne"
author: "Andrew Lampinen"
date: "March 11, 2020"
output: html_document
---

```{r}
library(tidyverse)
library(ggpubr)
library(tsne)
```
```{r}
theme_set(theme_classic())
```

# data loading

```{r}
results_dir = "./polynomial_rep_results"
num_runs = 5
```


```{r message=FALSE, warning=FALSE}
d = replicate(num_runs, data.frame())
for (run_i in 0:(num_runs-1)) {
  this_d = read_csv(sprintf("%s/run%i_task_representations.csv", results_dir, run_i)) 
  this_d = this_d %>%
    mutate(run = run_i)# %>%
    # gather(task, value, -run, -dimension) %>%
    # separate(task, c("task", "base_or_meta"), sep=":") %>%
    # mutate(base_or_meta = gsub("_[0-9]+", "", base_or_meta)) # some tasks are duplicated because of float precision.
    
  d[[run_i + 1]] = this_d
}
```

# PCA plots by run


```{r}
runs_to_plot = 4  # we plot a subset of the runs to make laying out the plots easier, results look similar across all
overall_plots = replicate(runs_to_plot, ggplot())
constant_poly_plots = replicate(runs_to_plot, ggplot())
single_var_poly_plots = replicate(runs_to_plot, ggplot())
meta_mapping_plots = replicate(runs_to_plot, ggplot())
meta_mapping_plots_34 = replicate(runs_to_plot, ggplot())
perm_mapping_plots = replicate(runs_to_plot, ggplot())
for (run_i in 1:runs_to_plot) {
  this_d = d[[run_i]]
  pcs = prcomp(this_d %>%
                 select(-dimension, -run), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  pc_d = pc_d %>% 
    separate(task, c("task", "base_or_meta"), sep=":") %>%
    mutate(base_or_meta = gsub("_[0-9]+", "", base_or_meta), # some tasks are duplicated because of float precision.
           meta_task_type = str_extract(task, "mult|add|perm|square")) %>%
    rowwise() %>%
    mutate(vars_relevant=ifelse(base_or_meta == "base",
                                str_extract_all(task, "X[0-4]") %>%
                                  unlist %>% unique %>% sort %>%
                                  paste(collapse=""),
                                NA)) %>%
    ungroup() %>%
    mutate(num_vars_relevant=str_length(vars_relevant)/2,
           base_or_meta = case_when(base_or_meta == "base" ~ "Base (polynomial)",
                                    base_or_meta == "meta_class" ~ "Meta Class.",
                                    base_or_meta == "meta_map" ~ "Meta Mapping",
                                    T ~ base_or_meta
           ))
  
  # overall: base + meta
  overall_plots[[run_i]] = ggplot(pc_d, aes(x=PC1, y=PC2, color=num_vars_relevant, shape=base_or_meta, size=base_or_meta)) +
    geom_point() +
    #scale_color_brewer(palette="Dark2") + 
    labs(x="PC 1", y="PC 2") +
#    scale_color_brewer(palette="Purples") +
    guides(color=guide_legend(title="Number of\nrelevant variables"),
           shape=guide_legend(title="Type"),
           size=guide_legend(title="Type"))
  
  # constant polynomials organized by value
  constant_poly_plots[[run_i]] = ggplot(pc_d %>%
           filter(num_vars_relevant == 0) %>%
           mutate(constant_val = as.numeric(task),
                  compressed_constant_val = ifelse(constant_val > 0,
                                                   sqrt(constant_val),
                                                   -sqrt(-constant_val))), 
         aes(x=PC1, y=PC2, color=compressed_constant_val)) +
    geom_point() +
    scale_color_gradient2() +#breaks=c(-4, -2, 0, 2, 4, 6),
                          #labels=c(-16, -4, 0, 4, 16, 36)) + 
    labs(x="PC 1", y="PC 2") +
    guides(color=guide_colorbar(title="Value\n(sqrt)"))
  
  # single variable polynomials
  single_var_poly_plots[[run_i]] = ggplot(pc_d %>%
           filter(num_vars_relevant == 1), 
         aes(x=PC1, y=PC2, color=vars_relevant)) +
    geom_point() +
    scale_color_brewer(palette="Set2") +
    labs(x="PC 1", y="PC 2") +
    guides(color=guide_legend(title="Variable"))
  
  # meta-mapping only PCA
  pcs = prcomp(this_d %>%
                 select(contains("meta_map")), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  pc_d = pc_d %>% 
    separate(task, c("task", "base_or_meta"), sep=":") %>%
    mutate(meta_task_type = str_extract(task, "mult|add|perm|square"),
           task = case_when(meta_task_type %in% c("mult", "add") ~ str_extract(task, "[a-z0-9_-]+"),
                            meta_task_type == "perm" ~ paste("perm", str_extract(task, "[0-3]+")),
                            T ~ task)) %>%
    mutate(base_or_meta = case_when(base_or_meta == "base" ~ "Base (polynomial)",
                                    base_or_meta == "meta_class" ~ "Meta Class.",
                                    base_or_meta == "meta_map" ~ "Meta Mapping",
                                    T ~ base_or_meta
           ))
  
  meta_mapping_plots[[run_i]] = ggplot(pc_d, aes(x=PC1, y=PC2, color=meta_task_type)) +
#    geom_point(size=1.5) +
    geom_text(aes(label=task),
              position=position_nudge(x=0.05)) +
    scale_color_brewer(palette="Set1") + 
    labs(x="PC 1", y="PC 2") +
    guides(color=F)
  
  meta_mapping_plots_34[[run_i]] = ggplot(pc_d, aes(x=PC3, y=PC4, color=meta_task_type)) +
#    geom_point(size=1.5) +
    geom_text(aes(label=task),
              position=position_nudge(x=0.05)) +
    scale_color_brewer(palette="Set1") + 
    labs(x="PC 3", y="PC 4") +
    guides(color=F)

  # perm only PCA
  pcs = prcomp(this_d %>%
                 select(contains("perm")), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  pc_d = pc_d %>% 
    separate(task, c("task", "base_or_meta"), sep=":") %>%
    mutate(meta_task_type = str_extract(task, "mult|add|perm|square"),
           task = case_when(meta_task_type %in% c("mult", "add") ~ str_extract(task, "[a-z0-9_-]+"),
                            meta_task_type == "perm" ~ paste("perm", str_extract(task, "[0-3]+")),
                            T ~ task)) %>%
    mutate(base_or_meta = case_when(base_or_meta == "base" ~ "Base (polynomial)",
                                    base_or_meta == "meta_class" ~ "Meta Class.",
                                    base_or_meta == "meta_map" ~ "Meta Mapping",
                                    T ~ base_or_meta
           ))
  
  perm_mapping_plots[[run_i]] = ggplot(pc_d, aes(x=PC1, y=PC2, color=meta_task_type)) +
#    geom_point(size=1.5) +
    geom_text(aes(label=task),
              position=position_nudge(x=0.05)) +
    scale_color_brewer(palette="Set1", drop=F) + 
    labs(x="PC 1", y="PC 2") +
    guides(color=F)
  
}
```


```{r}
ggarrange(overall_plots[[1]], overall_plots[[2]], overall_plots[[3]], overall_plots[[4]],  # plotlist arg isn't working and I don't want to debug it
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.75,
          common.legend=T)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/overall_PCA.png", width=8, height=8)
ggsave("../metamapping_paper/figures/polynomial_reps/overall_PCA.png", width=8, height=8)
```

```{r}
ggarrange(constant_poly_plots[[1]], constant_poly_plots[[2]], constant_poly_plots[[3]], constant_poly_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.75)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/constant_poly_PCA.png", width=8, height=6)
ggsave("../metamapping_paper/figures/polynomial_reps/constant_poly_PCA.png", width=8, height=6)
```

```{r}
ggarrange(single_var_poly_plots[[1]], single_var_poly_plots[[2]], single_var_poly_plots[[3]], single_var_poly_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.425,
          common.legend=T)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/single_var_poly_PCA.png", width=8, height=8)
```

```{r}
ggarrange(meta_mapping_plots[[1]], meta_mapping_plots[[2]], meta_mapping_plots[[3]], meta_mapping_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.425,
          common.legend=T)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/meta_mapping_PCA.png", width=8, height=8)
ggsave("../metamapping_paper/figures/polynomial_reps/meta_mapping_PCA.png", width=8, height=8)

```

```{r}
ggarrange(meta_mapping_plots_34[[1]], meta_mapping_plots_34[[2]], meta_mapping_plots_34[[3]], meta_mapping_plots_34[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.425,
          common.legend=T)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/meta_mapping_PCA_34.png", width=8, height=8)
#ggsave("../metamapping_paper/figures/polynomial_reps/meta_mapping_PCA_34.png", width=8, height=8)

```


```{r}
ggarrange(perm_mapping_plots[[1]], perm_mapping_plots[[2]], perm_mapping_plots[[3]], perm_mapping_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.425,
          common.legend=T)

ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/perm_mapping_PCA.png", width=8, height=8)
#ggsave("../metamapping_paper/figures/polynomial_reps/meta_mapping_PCA.png", width=8, height=8)

```


# analyzing homoiconicity's effect on representations

```{r}
similarities = replicate(num_runs, data.frame())
control_similarities = replicate(num_runs, data.frame())
for (run_i in 1:num_runs) {
  this_d = d[[run_i]] %>%
    select(-dimension, -run) %>%
    mutate_all(function(x) {return(x / sqrt(sum(x^2)))}) %>% # norm columns
    as.matrix
  
  similarities_matrix = t(this_d) %*% this_d
  
  similarities[[run_i]] = similarities_matrix %>%
    as.data.frame %>%
    mutate(task1 = rownames(similarities_matrix)) %>%
    pivot_longer(-task1, names_to="task2", values_to="similarity") %>%
    mutate(run=run_i)
  
  control_d = this_d 
  # shuffle
  for (i in 1:ncol(this_d)) {
    control_d[, i] = sample(control_d[, i], nrow(this_d), replace=F)
  }
  for (j in 1:nrow(this_d)) {
    control_d[j, ] = sample(control_d[j, ], ncol(this_d), replace=F)
  }
  control_similarities_matrix = t(control_d) %*% control_d
  
  similarities[[run_i]] = bind_rows(
    similarities_matrix %>%
      as.data.frame %>%
      mutate(task1 = rownames(similarities_matrix)) %>%
      pivot_longer(-task1, names_to="task2", values_to="similarity") %>%
      mutate(condition = "Real similarities"),
    control_similarities_matrix %>%
      as.data.frame %>%
      mutate(task1 = rownames(similarities_matrix)) %>%
      pivot_longer(-task1, names_to="task2", values_to="similarity") %>%
      mutate(condition = "Scrambled control")
    )%>%
      mutate(run=run_i)
  
}
similarities = bind_rows(similarities)
```

## what is similarity between meta-mapping reps and basic task reps?

```{r}
ggplot(data=similarities %>%
         filter(task1 != task2) %>%
         mutate(task1_is_meta = grepl("meta", task1),
                task2_is_meta = grepl("meta", task2),
                task_grouping = case_when(!task1_is_meta & ! task2_is_meta ~ "Base vs. base",
                                          !task1_is_meta &  task2_is_meta ~ "Base vs. meta",
                                          task1_is_meta &  task2_is_meta ~ "Meta vs. meta",
                                          T ~ "NA")) %>%
         filter(task_grouping != "NA", # drop duplicates
                condition == "Real similarities" | task_grouping == "Base vs. meta") %>%
         mutate(task_grouping = ifelse(condition == "Scrambled control",
                                       "Scrambled control", task_grouping),
                task_grouping = factor(task_grouping, levels=c("Scrambled control", "Base vs. base", "Meta vs. meta", "Base vs. meta")),
                run = sprintf("Run %i", run)), 
       
       aes(x=similarity, color=task_grouping)) +
  facet_wrap(. ~ run) +
  scale_color_manual(values=c("#000000", "#b2182b", "#dfc28d", "#4eb3d3")) +
  geom_density()  +
  guides(color=guide_legend(title="Task pairing")) +
  labs(x="Cosine between representations", y="Density") +
  theme(legend.position=c(0.85, 0.25))
  
ggsave("../metamapping_paper/figures/polynomial_reps/meta_base_rep_similarity.png", width=8, height=5)
```

```{r}
similarities %>%
  filter(task1 != task2) %>%
  mutate(task1_is_meta = grepl("meta", task1),
         task2_is_meta = grepl("meta", task2)) %>%
  filter(!task1_is_meta & task2_is_meta) %>%
  group_by(condition, run) %>%
  summarize(mean_similarity = mean(similarity),
            mean_abs_similarity = mean(abs(similarity)))
```


## now restrict to cross-similarities
```{r}
similarities = similarities %>%
  filter(condition == "Real similarities",
         grepl("meta", task1),
         grepl("base", task2))
```


## do add/mult align with constants?

```{r}
add_mult_constant_d = similarities %>%
  filter(grepl("add_|mult_", task1),
         !grepl("X", task2)) %>%
  mutate(meta_constant_val=as.numeric(str_extract(task1, "-?[0-9]+\\.[0-9]*")),
         base_constant_val=as.numeric(str_extract(task2, "-?[0-9]+\\.[0-9]*")),
         val_product=meta_constant_val * base_constant_val,
         same_sign=sign(meta_constant_val) == sign(base_constant_val),
         meta_task_type=str_extract(task1, "add|mult"))
```

```{r}
ggplot(add_mult_constant_d,
       aes(x=base_constant_val, y=similarity, fill=meta_task_type)) +
  geom_point() +
  facet_grid(meta_task_type~ meta_constant_val)
```

```{r}
ggplot(add_mult_constant_d,
       aes(x=same_sign, y=similarity, fill=meta_task_type)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~run)
```

```{r}
add_mult_constant_lms = add_mult_constant_d %>%
  group_by(meta_task_type, run) %>%
  do(result=summary(lm(.$similarity ~ .$same_sign)))
add_mult_constant_lms
```

```{r}
add_mult_constant_lms %>% 
  filter(meta_task_type == "add") %>%
  pull(result)
```


```{r}
add_mult_constant_lms %>% 
  filter(meta_task_type == "mult") %>%
  pull(result)
```

```{r}
ggplot(add_mult_constant_d,
       aes(x=run, y=similarity, fill=same_sign)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~meta_task_type)
```

```{r}
ggplot(add_mult_constant_d %>%
         filter(meta_task_type == "mult") %>%
         mutate(same_sign = ifelse(same_sign, "Same sign", "Different sign")),
       aes(x=run, y=similarity, fill=same_sign)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  scale_fill_manual(values=c("#d53e4f", "#abdda4")) +
  guides(fill=guide_legend(title="Base + meta\nsigns")) +
  labs(y="Cosine between representations", x="Run")
ggsave("../metamapping_paper/figures/polynomial_reps/mult_const_alignment.png", width=6, height=4)
```


## does squaring relate to square terms?

```{r}
squaring_d = similarities %>%
  filter(grepl("square", task1)) %>%
  mutate(base_contains_square = grepl("^2", task2),
         base_degree=case_when(!grepl("X", task2) ~ 0,
                               grepl("^2|X0X|X1X|X2X|X3X", task2) ~ 2,
                               T ~ 1))
```

```{r}
ggplot(squaring_d %>%
         filter(grepl("X", task2)),
       aes(x=base_contains_square, fill=base_contains_square, y=similarity)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~run)
```


```{r}
ggplot(squaring_d,
       aes(x=base_degree, y=similarity)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~run)
```

## do variables affected by permutations relate to variables present in a polynomial?

```{r}
perm_poly_d = similarities %>%
  filter(grepl("permute", task1),
         grepl("X", task2)) %>%
  mutate(meta_permutation=str_extract(task1, "[0-3]+"),
         meta_X0=substr(meta_permutation, 1, 1),
         meta_X1=substr(meta_permutation, 2, 2),
         meta_X2=substr(meta_permutation, 3, 3),
         meta_X3=substr(meta_permutation, 4, 4),
         meta_X0_affected=meta_X0 != 0,
         meta_X1_affected=meta_X1 != 1,
         meta_X2_affected=meta_X2 != 2,
         meta_X3_affected=meta_X3 != 3,
         base_X0_relevant = grepl("X0", task2),
         base_X1_relevant = grepl("X1", task2),
         base_X2_relevant = grepl("X2", task2),
         base_X3_relevant = grepl("X3", task2),
         meta_perm_is_transposition = meta_permutation %in% c("1023", "0213", "0132", "2103", "3120", "0321") # switches only two variables

  )
```

```{r}
ggplot(perm_poly_d %>%
         filter(meta_perm_is_transposition) %>%
         mutate(         
           transposed_variables_relevant = case_when(meta_permutation == "1023" & base_X0_relevant & base_X1_relevant ~ T, 
                                                     meta_permutation == "0213" & base_X1_relevant & base_X2_relevant ~ T, 
                                                     meta_permutation == "0132" & base_X2_relevant & base_X3_relevant ~ T, 
                                                     meta_permutation == "2103" & base_X0_relevant & base_X2_relevant ~ T, 
                                                     meta_permutation == "3120" & base_X0_relevant & base_X3_relevant ~ T, 
                                                     meta_permutation == "0321" & base_X1_relevant & base_X3_relevant ~ T, 
                                                    T ~ F)),
       aes(x=transposed_variables_relevant, fill=transposed_variables_relevant, y=similarity)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~run)
```

```{r}
ggplot(perm_poly_d %>%
         filter(meta_perm_is_transposition) %>%
         mutate(         
           preserved_variables_relevant = case_when(meta_permutation == "1023" & base_X2_relevant & base_X3_relevant ~ T, 
                                                    meta_permutation == "0213" & base_X0_relevant & base_X3_relevant ~ T, 
                                                    meta_permutation == "0132" & base_X0_relevant & base_X1_relevant ~ T, 
                                                    meta_permutation == "2103" & base_X1_relevant & base_X3_relevant ~ T, 
                                                    meta_permutation == "3120" & base_X1_relevant & base_X2_relevant ~ T, 
                                                    meta_permutation == "0321" & base_X0_relevant & base_X2_relevant ~ T, 
                                                    T ~ F)),
       aes(x=preserved_variables_relevant, fill=preserved_variables_relevant, y=similarity)) +
  geom_bar(stat="summary",
           fun.y="mean",
           position="dodge") +
  geom_linerange(stat="summary",
                 fun.data="mean_cl_boot",
                 position=position_dodge(0.9)) +
  facet_wrap(~run)
```


# looking at PCA subspace similarities

```{r}
all_simil_data = replicate(runs_to_plot, data.frame())
for (run_i in 1:runs_to_plot) {
  this_d = d[[run_i]]
  centered_d = this_d %>% 
    pivot_longer(-c(dimension, run), names_to="task", values_to="value") %>%
    group_by(dimension, run) %>%
    mutate(value = value - mean(value)) %>%
    ungroup() %>%
    pivot_wider(names_from=task, values_from=value)
    
  pcs = prcomp(centered_d %>%
                 select(-dimension, -run, -contains("meta")) %>% 
                 t(), center=F, scale=F)
  this_base_sds = pcs$sdev
  this_base_pcs = pcs$rotation

  
  # meta-mapping only PCA
  pcs = prcomp(centered_d %>%
                 select(contains("meta_map")) %>%
                 t(), center=F, scale=F)
  this_meta_sds = pcs$sdev
  this_meta_pcs = pcs$rotation
  
  PC_simils = t(this_base_pcs) %*% this_meta_pcs
  colnames(PC_simils) = paste("meta_", colnames(PC_simils), sep="")
  rownames(PC_simils) = paste("base_", rownames(PC_simils), sep="")
  
  # control
  control_d = centered_d %>%
                select(contains("meta_map")) %>%
                t()
  for (i in 1:512) {
    control_d[, i] = sample(control_d[, i], 20, replace=F)
  }
  for (j in 1:20) {
    control_d[j, ] = sample(control_d[j, ], 512, replace=F)
  }
  control_pcs = prcomp(control_d,
                       center=F, scale=F)
  control_meta_sds = control_pcs$sdev
  control_meta_pcs = control_pcs$rotation
  
  control_PC_simils = t(this_base_pcs) %*% control_meta_pcs
  colnames(control_PC_simils) = paste("meta_", colnames(control_PC_simils), sep="")
  rownames(control_PC_simils) = paste("base_", rownames(control_PC_simils), sep="")
  
  this_meta_variances = this_meta_sds^2
  this_meta_proportion_variances = this_meta_variances / sum(this_meta_variances)
  
  this_control_meta_variances = control_meta_sds^2
  this_control_meta_proportion_variances = this_control_meta_variances / sum(this_control_meta_variances)
  
  PC_simil_data = as.data.frame(PC_simils) %>%
    mutate(base_PC = row.names(.)) %>%
    mutate(condition = "Original")
  
  control_PC_simil_data = as.data.frame(control_PC_simils) %>%
    mutate(base_PC = row.names(.)) %>%
    mutate(condition = "Scrambled")
  
  all_simil_data[[run_i]] = bind_rows(PC_simil_data, control_PC_simil_data) %>%
    pivot_longer(starts_with("meta"), names_to="meta_PC", values_to="cosine_similarity") %>%
    mutate_at(vars(c("base_PC", "meta_PC")), function(x) {as.numeric(str_extract(x, "[0-9]+"))}) %>%
    mutate(run=run_i) %>%
    left_join(data.frame(meta_PC=c(1:length(this_meta_proportion_variances), 1:length(this_control_meta_proportion_variances)), 
                         meta_percent_variance=c(this_meta_proportion_variances, this_control_meta_proportion_variances),
                         condition=c(rep("Original", length(this_meta_proportion_variances)), rep("Scrambled", length(this_control_meta_proportion_variances)))))
}
all_simil_data = bind_rows(all_simil_data)
```

```{r}
all_simil_data = all_simil_data %>%
  mutate(plotting_run = sprintf("Run %i", run),
         plotting_condition = factor(condition, levels=c("Original", "Scrambled")))
```

## plotting comparison between original and control projections of top 20 modes 


Will color relative to the max similarity under the control and original distributions.

```{r}
cutoff = all_simil_data %>% 
  filter(condition == "Scrambled",
         base_PC <= 20) %>%
  pull(cosine_similarity) %>%
  abs %>%
  max

max_cutoff = all_simil_data %>% 
  filter(condition == "Original",
         base_PC <= 20) %>%
  pull(cosine_similarity) %>%
  abs %>%
  max
```

```{r}
ggplot(all_simil_data %>%
         filter(base_PC <= 20) %>%
         mutate(condition=factor(condition, levels=c("Original", "Scrambled"),
                                 labels=c("Original", "Scrambled control"))),
       aes(x=base_PC, y=meta_PC, fill=abs(cosine_similarity))) +
  geom_raster() + 
  scale_fill_gradient2(low="#FFFFFF", mid="#FFDD88", high="#008800", midpoint=cutoff,
                       limits=c(0., NA),
                       breaks=c(0, cutoff, max_cutoff), 
                       labels=c("0.", sprintf("%.2f — max.\nin scrambled", cutoff), sprintf("%.2f — max.\nin original", max_cutoff))) +
  facet_grid(condition ~ plotting_run) +
  labs(x="Base P.C. index", y="Meta P.C. index") +
  guides(fill=guide_colorbar(title="Alignment\n(Abs. cosine)\n"))

ggsave("../metamapping_paper/figures/polynomial_reps/top_PC_alignments.png", width=8, height=6)
```

## how much variance of meta reps is contained in first few principle components of the base reps?

```{r}
shared_variance_d = all_simil_data %>%
  mutate(variance_contained = abs(cosine_similarity)^2 * meta_percent_variance) %>% 
  group_by(plotting_run, condition, base_PC) %>%
  summarize(PC_variance_contained = sum(variance_contained)) %>%
  group_by(plotting_run, condition) %>%
  mutate(cumulative_variance_contained = cumsum(PC_variance_contained)) %>%
  ungroup()
```

```{r}
ggplot(data=shared_variance_d %>%
         mutate(condition=factor(condition, levels=c("Original", "Scrambled"),
                                 labels=c("Original", "Scrambled\ncontrol"))),
       aes(x=base_PC, y=cumulative_variance_contained, color=condition)) +
  geom_line() +
  facet_wrap(~plotting_run) +
  scale_color_manual(values=c("#005500", "#EECC77")) +
  labs(x="Base PC index",
       y="Cumulative meta representation variance explained")
  
ggsave("../metamapping_paper/figures/polynomial_reps/cumulative_PC_variance.png", width=8, height=5)
```


# mapped representations plots


```{r message=FALSE, warning=FALSE}
mapped_results_dir = "./polynomial_mapped_rep_results"
mappings_to_load = c("add_3.000000", "mult_3.000000", "permute_1230", "permute_1032", "square")
num_mapped_runs = 4
mapped_d = replicate(num_runs, data.frame())
for (run_i in 0:(num_mapped_runs-1)) {
  this_d = read_csv(sprintf("%s/run%i_task_representations.csv", mapped_results_dir, run_i)) 
  this_d = this_d %>%
    mutate(run = run_i)# %>%
  curr_colnames = colnames(this_d)
  colnames(this_d) = c("dimension", paste(curr_colnames[2:(length(curr_colnames) - 1)], sprintf(":%s", "None"), sep=""), "run")
  for (this_mapping in mappings_to_load) {
    this_mapped_d = read_csv(sprintf("%s/run%i_task_representations__mapped-%s.csv", mapped_results_dir, run_i, this_mapping)) 
    this_mapped_d = this_mapped_d %>%
      select(-dimension)
    colnames(this_mapped_d) = paste(colnames(this_mapped_d), sprintf(":mapping_%s", this_mapping), sep="")
    this_d = bind_cols(this_d, 
                       this_mapped_d)
  }
    
  mapped_d[[run_i + 1]] = this_d
}
```

## PCA plots by run


```{r}
runs_to_plot = 4  # we plot a subset of the runs to make laying out the plots easier
# overall_plots = replicate(runs_to_plot, ggplot())
# constant_poly_plots = replicate(runs_to_plot, ggplot())
# single_var_poly_plots = replicate(runs_to_plot, ggplot())
# meta_mapping_plots = replicate(runs_to_plot, ggplot())
# meta_mapping_plots_34 = replicate(runs_to_plot, ggplot())
# perm_mapping_plots = replicate(runs_to_plot, ggplot())
#for (run_i in 1:runs_to_plot) {
  run_i = 4
  this_d = mapped_d[[run_i]]
  pcs = prcomp(this_d %>%
                 select(-dimension, -run), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  pc_d = pc_d %>% 
    separate(task, c("task", "base_or_meta", "mapping"), sep=":") %>%
    mutate(meta_task_type = str_extract(task, "mult|add|perm|square")) %>%
    rowwise() %>%
    mutate(vars_relevant=ifelse(base_or_meta == "base",
                                str_extract_all(task, "X[0-4]") %>%
                                  unlist %>% unique %>% sort %>%
                                  paste(collapse=""),
                                NA)) %>%
    ungroup() %>%
    mutate(num_vars_relevant=str_length(vars_relevant)/2,
           base_or_meta = case_when(base_or_meta == "base" ~ "Base (polynomial)",
                                    base_or_meta == "meta_class" ~ "Meta Class.",
                                    base_or_meta == "meta_map" ~ "Meta Mapping",
                                    T ~ base_or_meta
           )) %>%
    pivot_longer(starts_with("PC"), names_to="PC") %>%
    unite(PC_mapping, PC, mapping) %>%
    distinct() %>%
    pivot_wider(names_from=PC_mapping, values_from=value) %>%
    mutate(base_or_meta = gsub("_[0-9]+", "", base_or_meta)) # some tasks are duplicated because of float precision.
  
  

```

```{r}
ggplot(pc_d %>%
           filter(base_or_meta == "Base (polynomial)") %>%
           mutate(constant_val = as.numeric(str_extract(task, "^[-]?[0-9]+\\.[0-9]++")),
                  compressed_constant_val = ifelse(constant_val > 0,
                                                   sqrt(constant_val),
                                                   -sqrt(-constant_val))), 
         aes(x=PC1_None, y=PC2_None, xend=`PC1_mapping_add_3.000000`, yend=`PC2_mapping_add_3.000000`, color=compressed_constant_val)) +
    geom_segment(arrow=arrow(angle=15, length=unit(0.1, "inches"), type="closed")) +
    labs(x="PC 1", y="PC 2") +
    scale_color_gradient2(breaks=c(-4, -2, 0, 2, 4, 6),
                          labels=c(-16, -4, 0, 4, 16, 36)) + 
    guides(color=guide_colorbar(title="Polynomial\nconstant\nterm"))
ggsave("../metamapping_paper/figures/polynomial_reps/rep_shift_add_3.png", width=8, height=6)
```

```{r}
  ggplot(pc_d %>%
           filter(base_or_meta == "Base (polynomial)") %>%
           mutate(constant_val = as.numeric(str_extract(task, "^[-]?[0-9]+\\.[0-9]++")),
                  compressed_constant_val = ifelse(constant_val > 0,
                                                   sqrt(constant_val),
                                                   -sqrt(-constant_val))), 
         aes(x=PC1_None, y=PC2_None, xend=`PC1_mapping_mult_3.000000`, yend=`PC2_mapping_mult_3.000000`, color=compressed_constant_val, shape=as.factor(num_vars_relevant))) +
    geom_segment(arrow=arrow(angle=15, length=unit(0.1, "inches"), type="closed")) +
    labs(x="PC 1", y="PC 2") +
    scale_color_gradient2(breaks=c(-4, -2, 0, 2, 4, 6),
                          labels=c(-16, -4, 0, 4, 16, 36)) + 
    guides(color=guide_colorbar(title="Polynomial\nconstant\nterm"))
ggsave("../metamapping_paper/figures/polynomial_reps/rep_shift_mult_3.png", width=8, height=6)
```

```{r}
p = ggplot(pc_d %>%
         filter(base_or_meta == "Base (polynomial)") %>%
         mutate(constant_val = as.numeric(str_extract(task, "^[-]?[0-9]+\\.[0-9]++")),
                compressed_constant_val = ifelse(constant_val > 0,
                                                 sqrt(constant_val),
                                                 -sqrt(-constant_val)),
                is_constant = ifelse(num_vars_relevant == 0, "Constant polynomials", "Non-constant polynomials")), 
       aes(x=PC1_None, y=PC2_None, xend=`PC1_mapping_square`, yend=`PC2_mapping_square`, color=compressed_constant_val, shape=as.factor(num_vars_relevant))) +
  geom_segment(arrow=arrow(angle=15, length=unit(0.1, "inches"), type="closed")) +
  labs(x="PC 1", y="PC 2") +
  scale_color_gradient2(breaks=c(-4, -2, 0, 2, 4, 6),
                        labels=c(-16, -4, 0, 4, 16, 36)) + 
  guides(color=guide_colorbar(title="Polynomial\nconstant\nterm")) #+
#  facet_wrap(~is_constant)
ggsave("../metamapping_paper/figures/polynomial_reps/rep_shift_square.png", plot=p, width=8, height=6)
ggsave("../metamapping_paper/figures/polynomial_reps/rep_shift_square_faceted.png", 
       plot=p + facet_wrap(~is_constant), width=10, height=6)
p
```

```{r}
  ggplot(pc_d %>%
           filter(base_or_meta == "Base (polynomial)",
                  num_vars_relevant > 0) %>%
           mutate(constant_val = as.numeric(str_extract(task, "^[-]?[0-9]+\\.[0-9]++")),
                  compressed_constant_val = ifelse(constant_val > 0,
                                                   sqrt(constant_val),
                                                   -sqrt(-constant_val))), 
         aes(x=PC1_None, y=PC2_None, xend=`PC1_mapping_permute_1032`, yend=`PC2_mapping_permute_1032`, color=compressed_constant_val, shape=as.factor(num_vars_relevant))) +
  geom_segment(arrow=arrow(angle=15, length=unit(0.1, "inches"), type="closed")) +
  labs(x="PC 1", y="PC 2") +
  scale_color_gradient2(breaks=c(-4, -2, 0, 2, 4),
                        labels=c(-16, -4, 0, 4, 16)) + 
  guides(color=guide_colorbar(title="Polynomial\nconstant\nterm")) #+
ggsave("../metamapping_paper/figures/polynomial_reps/rep_shift_permute_1032.png", width=8, height=6)
```

```{r}
ggarrange(overall_plots[[1]], overall_plots[[2]], overall_plots[[3]], overall_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.75,
          common.legend=T)

#ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/overall_PCA.png", width=8, height=8)
#ggsave("../metamapping_paper/figures/polynomial_reps/overall_PCA.png", width=8, height=8)
```

```{r}
ggarrange(constant_poly_plots[[1]], constant_poly_plots[[2]], constant_poly_plots[[3]], constant_poly_plots[[4]], 
          labels=sprintf("Run %i", 0:(runs_to_plot-1)),
          label.x=0.75)

#ggsave("../../psych/dissertation/2-HoMM/figures/polynomial_reps/constant_poly_PCA.png", width=8, height=6)
#ggsave("../metamapping_paper/figures/polynomial_reps/constant_poly_PCA.png", width=8, height=6)
```